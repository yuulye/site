<h3>
  <a href="/">Home</a>
  |
  <%= title %>
</h3>
<hr/>
<table border=1>
  <thead>
    <tr>
      <th>#</th>
      <th>name</th>
      <th>level</th>
      <th>steps</th>
    </tr>
  </thead>
  <tbody id="table"></tbody>
</table>

<div style="display: none">
  <table>
    <tr id="tplTR">
      <td class="pos number"></td>
      <td class="name"></td>
      <td class="level number"></td>
      <td class="steps number"></td>
    </tr>
  </table>
</div>

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"
></script>

<script>
/* code */
$(() => {
  const old = JSON.parse(localStorage.getItem('players'));
  const players = <%- JSON.stringify(players) %>;
  players.sort((a, b) => b.level - a.level);
  for (let i = 0; i < players.length; i++) {
    const o = players[i];

    const el = $(tplTR).clone(false).removeAttr('id');
    el.find(".pos").text(i+1);
    el.find(".name").text(o.name);
    $(table).append(el);

    let level = o.level;
    let steps = o.steps;

    if (old) {
      const p = old.find(el => el.id === o.id);
      if (p) {
        let status = 'down';
        let color = 'red';

        // level
        if (p.level !== o.level) {

          if (o.level > p.level) {
            status = 'up';
            color = 'green';
          }
          level = `<i style="color: ${color}"`
            + ` class="fa fa-caret-${status}"></i> `
            + level 
          ;
        }

        // steps
        status = 'down';
        color = 'red';
        if (
          steps && p.steps && o.steps
          &&
          p.steps !== o.steps
        ) {
          if (
            Number(o.steps.replace(',', '')) > Number(p.steps.replace(',', ''))
          ) {
            status = 'up';
            color = 'green';
          }
          steps = `<i style="color: ${color}"`
            + ` class="fa fa-caret-${status}"></i> `
            + steps 
          ;
        }
      }
    }
    el.find(".level").html(level);
    el.find(".steps").html(steps);
  }
  localStorage.setItem('players', JSON.stringify(players));
});
/* code */
</script>

